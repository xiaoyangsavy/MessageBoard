<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<!-- meta使用viewport以确保页面可自由缩放 -->
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- 引入 jQuery Mobile 样式 -->
<link rel="stylesheet" type="text/css" href="css/jquery.mobile-1.4.5.min.css">
<link rel="stylesheet" type="text/css" href="css/login.css">
<!-- 引入 jQuery 库 -->
 <script type="text/javascript" src="js/jquery.min.js"></script>
<!-- 引入 jQuery Mobile 库 -->
 <script type="text/javascript" src="js/jquery.mobile-1.4.5.min.js"></script>
 <!-- 引入项目公共逻辑库 -->
 <script type="text/javascript" src="js/common.js"></script>

	<!-- 评分 -->
<link rel="stylesheet" href="css/rating-main.css">
    <link rel="stylesheet" href="css/css-stars.css">
 
</head>
<body>

<div data-role="page">
  <div data-role="header" data-position="fixed">
    <a href="javascript:history.back(-1)" class="ui-btn ui-corner-all ui-icon-arrow-l ui-btn-icon-notext">左箭头图标</a>
    <h1>内容详情</h1>
    <a id="replay-button" onclick="goReply()"class="ui-btn ui-corner-all ui-shadow ui-icon-comment ui-btn-icon-left">回复</a>
  </div>

  <div  data-role="main" class="ui-content">
  <div id="content-div">
 
    <h4 id="messageTitle" align="center">用户留言： </h4>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    <label id=""> 留言内容
    </label>
    
    
 <!--  图片显示 -->
    <br/><img src="images/test01.jpg" width="100%" >&nbsp;&nbsp;&nbsp;&nbsp;<img src="images/test02.jpg" width="100%" >&nbsp;&nbsp;&nbsp;&nbsp;<img src="images/test03.jpg" width="100%" >
    <img src="images/test04.jpg" width="100%" >&nbsp;&nbsp;&nbsp;&nbsp;<img src="images/test05.jpg" width="100%" >&nbsp;&nbsp;&nbsp;&nbsp;<img src="images/test06.jpg" width="100%" >
    <!--  视频播放 -->
    <p>视频:</p>
	<br/><video src="images/test.mp4" width="100%"  align="center" controls autoplay></video>
    &nbsp;<br/><video src="images/test.mp4" width="100%"  align="center" controls autoplay></video>
	<!--  音频播放
	<audio src="../files/sound.mp3" id="audio" width="100%"  align="center" controls autoplay></audio> -->
    <p>音频:</p>
 <audio controls>
  <source src="files/sound.mp3" type="audio/mpeg">
您的浏览器不支持 audio 元素。
</audio>
&nbsp;<br/>
 <audio controls>
  <source src="files/sound.mp3" type="audio/mpeg">
您的浏览器不支持 audio 元素。
</audio>
<br/>
  </div>
  </div>
  
   <div data-role="footer">
<h4 align="left" style="text-align:center">回复</h4>
<div id="reply-div">
     
     
    <label>回复内容
    </label>
    
    
 <!--  图片显示 -->
    <br/><img src="images/test01.jpg" width="100%" > 
    <!--  视频播放 -->
    <p>视频:</p>
	<br/><video src="images/test.mp4" width="100%"  align="center" controls autoplay></video>
	<!--  音频播放
	<audio src="../files/sound.mp3" id="audio" width="100%"  align="center" controls autoplay></audio> -->
    <p>音频:</p>
 <audio controls>
  <source src="files/sound.mp3" type="audio/mpeg">
您的浏览器不支持 audio 元素。
</audio>

    
  </div>
  
  
  
 </div>
 

<br/>
 <div id="grade-div" class="stars stars-example-css">
 <span class="title">评分</span>
                <select id="example-css" name="rating" autocomplete="off" data-role="none">
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                </select>
                
                 <table style="margin: 0 auto">
    <tr><td align="center">
      <input type="submit" onclick="grade()" data-inline="true" value="确定评分">
      </td></tr>
     </table>
              </div><br/>
</div> 

 <script>          
    $(document).on("mobileinit", function(){
      $.mobile.ignoreContentEnabled = true;
    });
  </script>
    <script src="js/jquery.barrating.js"></script>
    <script src="js/examples.js"></script>
    
    
<script type="text/javascript">

//获取页面跳转时传递的参数
	var messageId= getUrlParams("messageId");	//留言编号
    console.log("messageId="+messageId);
 
 var permission = 0;	//权限
 
 var isReplay = false; //是否回复


$(function(){
if(!debug){
 //查找用户权限
   $.ajax({
        type: "GET",
        url:  serverUrl+"user/getPermission?userName="+getUsername(),
        contentType: "application/json",
        success: function (data) {
			console.log("call user/getPermission");
			console.log(data);
	 		if(data.status==200){	//调用成功
			console.log("getPermission:");
			console.log(data.data);
			permission = data.data;
			
			}else{
				openPopup("权限获取失败，请重新登录！");
			}
        },
        error: function (e) {
			console.log(e);
            openPopup("权限获取失败，请重新登录！");
        }
    });

   //获取页面数据
 $.ajax({
        type: "GET",
        url:  serverUrl+"message/viewProblem?superMessageId="+messageId,
        contentType: "application/json",
        success: function (data) {
			console.log("call message/viewProblem");
			console.log(data);
	 		if(data.status==200){	//调用成功	
 
 				//var exitReply = false;
				//if(data.data.length>1){
				//	exitReply = true;
				//}
				
				var len = data.data.length;
				console.log("length:"+len);
 			 for(var i = 0; i < len; i++){	//只遍历了一次
				 console.log("i="+i);
				console.log(data.data[i]);
			 	var item = data.data[i];
				//评分控件默认显示值
				 var grade = item.messageGrade;
				 $("#example-css").val(grade);	//TODO需要修改js文件逻辑
	 
	 			//document.getElementById("content-div").innerHTML = '';
	 			document.getElementById("reply-div").innerHTML = '<h4 id="messageTitle" align="center">无</h4>';
				if(i==0){	//用户留言内容
				var html = '';
			   	html += '<h4 align="center">'+item.messageTitle+'</h4>';
			   	html += '<label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'+item.messageContent+'</label><br/>';
				if(item.imageUrl != null&&item.imageUrl != undefined && item.imageUrl != ''){
			   	for(var j = 0,len = item.imageUrl.length; j < len; j++){	//图片
				html += '<img src="'+item.imageUrl[j]+'" width="100%" >&nbsp;&nbsp;&nbsp;&nbsp;';
				 }
				}
				 if(item.videoUrl!=null&&item.videoUrl != undefined && item.videoUrl != ''){
					 	html += '<p>视频:</p><br/>';
				for(var j = 0,len = item.videoUrl.length; j < len; j++){	//视频
				html += '<video src="'+item.videoUrl[j]+'" width="100%"  align="center" controls autoplay></video>&nbsp;<br/>';
				 }
				 }
				if(item.voiceUrl!=null&&item.voiceUrl != undefined && item.voiceUrl != ''){
				html += ' <p>音频:</p><br/>';
			   	for(var j = 0,len = item.voiceUrl.length; j < len; j++){	//音频
				 html += '<audio controls>  <source src="'+item.voiceUrl[j]+'" type="audio/mpeg"> 您的浏览器不支持 audio 元素。</audio>';
				 }
				}
				
				document.getElementById("content-div").innerHTML = html;

				isReplay = item.replay;	//是否回复
				
			   }else{	//管理员回复内容
			   console.log("reply:");
			   console.log(item);
			   	var html = '';
			   	html += '<label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'+item.messageContent+'</label><br/>';
				if(item.imageUrl != null&&item.imageUrl != undefined && item.imageUrl != ''){
			   	for(var j = 0,len = item.imageUrl.length; j < len; j++){	//图片
				html += '<img src="'+item.imageUrl[j]+'" width="100%" >&nbsp;&nbsp;&nbsp;&nbsp;';
				 }
				}
				 if(item.videoUrl!=null&&item.videoUrl != undefined && item.videoUrl != ''){
					 	html += '<p>视频:</p><br/>';
				for(var j = 0,len = item.videoUrl.length; j < len; j++){	//视频
				html += '<video src="'+item.videoUrl[j]+'" width="100%"  align="center" controls autoplay></video>&nbsp;<br/>';
				 }
				 }
				if(item.voiceUrl!=null&&item.voiceUrl != undefined && item.voiceUrl != ''){
				html += ' <p>音频:</p><br/>';
			   	for(var j = 0,len = item.voiceUrl.length; j < len; j++){	//音频
				 html += '<audio controls>  <source src="'+item.voiceUrl[j]+'" type="audio/mpeg"> 您的浏览器不支持 audio 元素。</audio>';
				 }
				}
				 document.getElementById("reply-div").innerHTML = html;
			}

			   
				 
			 }
			 console.log("permission="+permission+"isReplay="+isReplay)
			 if(permission==0){	//用户
				$("#replay-button").hide();//隐藏发布按钮
				if(isReplay){
				$("#grade-div").show();	//显示评分控件
				}else{
				$("#grade-div").hide();	//隐藏评分控	
				}
			}else{
				$("#replay-button").show();//显示发布按钮
				$("#grade-div").hide();	//隐藏评分控件
			}
			}else{
				openPopup(data.message);
			}
        },
        error: function (e) {
			console.log(e);
            openPopup("权限获取失败，请重新登录！");
        }
    });

	}else{
	//测试代码
	}
});

//管理员回复
function goReply(){
	window.location.href='view/addMessage.html?messageId='+messageId;
}
  </script>
</body>
</html>
